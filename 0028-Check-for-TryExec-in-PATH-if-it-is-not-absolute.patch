From a6cb08074fdfdee8673a910ef64eb17428b0b390 Mon Sep 17 00:00:00 2001
From: Gabriel Martinez <reitaka@gmail.com>
Date: Thu, 12 Mar 2015 16:45:38 -0700
Subject: [PATCH 29/29] Check for TryExec in $PATH if it is not absolute

GitHub issue #375
---
 src/greeter/SessionModel.cpp | 21 +++++++++++++++++++--
 1 file changed, 19 insertions(+), 2 deletions(-)

diff --git a/src/greeter/SessionModel.cpp b/src/greeter/SessionModel.cpp
index 32be117..92321a3 100644
--- a/src/greeter/SessionModel.cpp
+++ b/src/greeter/SessionModel.cpp
@@ -24,6 +24,7 @@
 #include <QDir>
 #include <QFile>
 #include <QList>
+#include <QProcessEnvironment>
 #include <QTextStream>
 
 #include <memory>
@@ -67,9 +68,25 @@ namespace SDDM {
                 if (line.startsWith("Comment="))
                     si->comment = line.mid(8);
                 if (line.startsWith("TryExec=")) {
-                    QFileInfo fi(line.mid(8));
-                    if (!fi.exists() || !fi.isExecutable())
+                    QString tryExecBin = line.mid(8);
+                    QFileInfo fi(tryExecBin);
+                    if (fi.isAbsolute()) {
+                        if (!fi.exists() || !fi.isExecutable())
+                            execAllowed = false;
+                    } else {
                         execAllowed = false;
+                        QProcessEnvironment env = QProcessEnvironment::systemEnvironment();
+                        QString envPath = env.value("PATH");
+                        QStringList pathList = envPath.split(':');
+                        foreach(const QString &path, pathList) {
+                            QDir pathDir(path);
+                            fi.setFile(pathDir, tryExecBin);
+                            if (fi.exists() && fi.isExecutable()) {
+                                execAllowed = true;
+                                break;
+                            }
+                        }
+                    }
                 }
             }
             // add to sessions list
-- 
1.9.0

