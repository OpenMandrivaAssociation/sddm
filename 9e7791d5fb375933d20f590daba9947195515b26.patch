From 9e7791d5fb375933d20f590daba9947195515b26 Mon Sep 17 00:00:00 2001
From: Ilya Fedin <fedin-ilja2010@ya.ru>
Date: Sun, 9 Jul 2023 00:10:55 +0400
Subject: [PATCH] Let GreeterEnvironment option take the precedence over PAM
 environment

---
 src/helper/Backend.cpp   | 18 +++++++++++++++---
 src/helper/HelperApp.cpp | 13 -------------
 2 files changed, 15 insertions(+), 16 deletions(-)

diff --git a/src/helper/Backend.cpp b/src/helper/Backend.cpp
index 47b6938a5..5a1dd6076 100644
--- a/src/helper/Backend.cpp
+++ b/src/helper/Backend.cpp
@@ -59,10 +59,10 @@ namespace SDDM {
     }
 
     bool Backend::openSession() {
+        QProcessEnvironment env = m_app->session()->processEnvironment();
         struct passwd *pw;
         pw = getpwnam(qPrintable(qobject_cast<HelperApp*>(parent())->user()));
         if (pw) {
-            QProcessEnvironment env = m_app->session()->processEnvironment();
             env.insert(QStringLiteral("HOME"), QString::fromLocal8Bit(pw->pw_dir));
             env.insert(QStringLiteral("PWD"), QString::fromLocal8Bit(pw->pw_dir));
             env.insert(QStringLiteral("SHELL"), QString::fromLocal8Bit(pw->pw_shell));
@@ -104,9 +104,21 @@ namespace SDDM {
             QProcessEnvironment::systemEnvironment().insert(savedEnv);
         }
 #endif
-            // TODO: I'm fairly sure this shouldn't be done for PAM sessions, investigate!
-            m_app->session()->setProcessEnvironment(env);
         }
+        if (env.value(QStringLiteral("XDG_SESSION_CLASS")) == QLatin1String("greeter")) {
+            // Qt internally may load the xdg portal system early on, prevent this, we do not have a functional session running.
+            env.insert(QStringLiteral("QT_NO_XDG_DESKTOP_PORTAL"), QStringLiteral("1"));
+            for (const auto &entry : mainConfig.GreeterEnvironment.get()) {
+                const int index = entry.indexOf(QLatin1Char('='));
+                if (index < 0) {
+                    qWarning() << "Malformed environment variable" << entry;
+                    continue;
+                }
+                env.insert(entry.left(index), entry.mid(index + 1));
+            }
+        }
+        // TODO: I'm fairly sure this shouldn't be done for PAM sessions, investigate!
+        m_app->session()->setProcessEnvironment(env);
         return m_app->session()->start();
     }
 
diff --git a/src/helper/HelperApp.cpp b/src/helper/HelperApp.cpp
index 9951e46e4..14cf27612 100644
--- a/src/helper/HelperApp.cpp
+++ b/src/helper/HelperApp.cpp
@@ -167,19 +167,6 @@ namespace SDDM {
         m_user = m_backend->userName();
         QProcessEnvironment env = authenticated(m_user);
 
-        if (env.value(QStringLiteral("XDG_SESSION_CLASS")) == QLatin1String("greeter")) {
-            // Qt internally may load the xdg portal system early on, prevent this, we do not have a functional session running.
-            env.insert(QStringLiteral("QT_NO_XDG_DESKTOP_PORTAL"), QStringLiteral("1"));
-            for (const auto &entry : mainConfig.GreeterEnvironment.get()) {
-                const int index = entry.indexOf(QLatin1Char('='));
-                if (index < 0) {
-                    qWarning() << "Malformed environment variable" << entry;
-                    continue;
-                }
-                env.insert(entry.left(index), entry.mid(index + 1));
-            }
-        }
-
         if (!m_session->path().isEmpty()) {
             env.insert(m_session->processEnvironment());
             m_session->setProcessEnvironment(env);
